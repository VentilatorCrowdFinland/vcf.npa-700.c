
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>npa_700.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;npa_700.h&quot;</a>
<a name="ln2"> </a>
<a name="ln3">#include &lt;stdbool.h&gt;</a>
<a name="ln4">#include &lt;stdlib.h&gt;</a>
<a name="ln5"> </a>
<a name="ln6">/**</a>
<a name="ln7"> * @addtogroup NPA-700</a>
<a name="ln8"> * @{</a>
<a name="ln9"> */</a>
<a name="ln10">/**</a>
<a name="ln11"> * @file npa_700.c</a>
<a name="ln12"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln13"> * @date 2020-04-05</a>
<a name="ln14"> * @copyright Otso Jousimaa, License Apache 2.0.</a>
<a name="ln15"> *</a>
<a name="ln16"> */</a>
<a name="ln17"> </a>
<a name="ln18">/**</a>
<a name="ln19"> * @brief Validate NPA Context.</a>
<a name="ln20"> *</a>
<a name="ln21"> * A valid context must have non-null R/W pointers.</a>
<a name="ln22"> *</a>
<a name="ln23"> * @param[in] sensor Sensor context to check.</a>
<a name="ln24"> * @return @ref npa_ret_t.</a>
<a name="ln25"> */</a>
<a name="ln26">static npa_ret_t npa_ctx_check (const npa_ctx_t * const sensor)</a>
<a name="ln27">{</a>
<a name="ln28">    npa_ret_t ret_code = NPA_SUCCESS;</a>
<a name="ln29"> </a>
<a name="ln30">    if (NULL == sensor)</a>
<a name="ln31">    {</a>
<a name="ln32">        ret_code |= NPA_ERR_NULL;</a>
<a name="ln33">    }</a>
<a name="ln34">    else if (NULL == sensor-&gt;write)</a>
<a name="ln35">    {</a>
<a name="ln36">        ret_code |= NPA_ERR_NULL;</a>
<a name="ln37">    }</a>
<a name="ln38">    else if (NULL == sensor-&gt;read)</a>
<a name="ln39">    {</a>
<a name="ln40">        ret_code |= NPA_ERR_NULL;</a>
<a name="ln41">    }</a>
<a name="ln42">    else</a>
<a name="ln43">    {</a>
<a name="ln44">        // No action needed.</a>
<a name="ln45">    }</a>
<a name="ln46"> </a>
<a name="ln47">    return ret_code;</a>
<a name="ln48">}</a>
<a name="ln49"> </a>
<a name="ln50">static npa_ret_t parse_status (const uint8_t data)</a>
<a name="ln51">{</a>
<a name="ln52">    npa_ret_t ret_code = NPA_SUCCESS;</a>
<a name="ln53">    uint32_t status_bits = data &gt;&gt; 6U;</a>
<a name="ln54"> </a>
<a name="ln55">    switch (status_bits)</a>
<a name="ln56">    {</a>
<a name="ln57">        case 0U:</a>
<a name="ln58">            // No action needed</a>
<a name="ln59">            break;</a>
<a name="ln60"> </a>
<a name="ln61">        case 1U:</a>
<a name="ln62">            // Configuration not supported by this driver, configuration mode is always error.</a>
<a name="ln63">            ret_code |= NPA_ERR_MODE;</a>
<a name="ln64">            break;</a>
<a name="ln65"> </a>
<a name="ln66">        case 2U:</a>
<a name="ln67">            ret_code |= NPA_WARN_OLD;</a>
<a name="ln68">            break;</a>
<a name="ln69"> </a>
<a name="ln70">        case 3U:</a>
<a name="ln71">        default:</a>
<a name="ln72">            ret_code |= NPA_ERR_FATAL;</a>
<a name="ln73">            break;</a>
<a name="ln74">    }</a>
<a name="ln75"> </a>
<a name="ln76">    return ret_code;</a>
<a name="ln77">}</a>
<a name="ln78"> </a>
<a name="ln79">// Return true if value has been saturated.</a>
<a name="ln80">static bool check_saturation (const uint16_t value)</a>
<a name="ln81">{</a>
<a name="ln82">    bool saturated = false;</a>
<a name="ln83"> </a>
<a name="ln84">    if (NPA_PRES_MIN_NONSAT &gt; value)</a>
<a name="ln85">    {</a>
<a name="ln86">        saturated = true;</a>
<a name="ln87">    }</a>
<a name="ln88"> </a>
<a name="ln89">    if (NPA_PRES_MAX_NONSAT &lt; value)</a>
<a name="ln90">    {</a>
<a name="ln91">        saturated = true;</a>
<a name="ln92">    }</a>
<a name="ln93"> </a>
<a name="ln94">    return saturated;</a>
<a name="ln95">}</a>
<a name="ln96"> </a>
<a name="ln97">// Get min/max pressure of given sensor</a>
<a name="ln98">static npa_ret_t get_scaling (const npa_variant_t model, float * const Pmax,</a>
<a name="ln99">                              float * const Pmin)</a>
<a name="ln100">{</a>
<a name="ln101">    npa_ret_t ret_code = NPA_SUCCESS;</a>
<a name="ln102"> </a>
<a name="ln103">    switch (model)</a>
<a name="ln104">    {</a>
<a name="ln105">        case NPA_700_02WD:</a>
<a name="ln106">            *Pmax = NPA_02WD_SCALE_PA;</a>
<a name="ln107">            *Pmin = -1.0F * NPA_02WD_SCALE_PA;</a>
<a name="ln108">            break;</a>
<a name="ln109"> </a>
<a name="ln110">        case NPA_700_05WD:</a>
<a name="ln111">            *Pmax = NPA_05WD_SCALE_PA;</a>
<a name="ln112">            *Pmin = -1.0F * NPA_05WD_SCALE_PA;</a>
<a name="ln113">            break;</a>
<a name="ln114"> </a>
<a name="ln115">        case NPA_700_10WD:</a>
<a name="ln116">            *Pmax = NPA_10WD_SCALE_PA;</a>
<a name="ln117">            *Pmin = -1.0F * NPA_10WD_SCALE_PA;</a>
<a name="ln118">            break;</a>
<a name="ln119"> </a>
<a name="ln120">        case NPA_700_001D:</a>
<a name="ln121">            *Pmax = NPA_001D_SCALE_PA;</a>
<a name="ln122">            *Pmin = -1.0F * NPA_001D_SCALE_PA;</a>
<a name="ln123">            break;</a>
<a name="ln124"> </a>
<a name="ln125">        case NPA_700_005D:</a>
<a name="ln126">            *Pmax = NPA_005D_SCALE_PA;</a>
<a name="ln127">            *Pmin = -1.0F * NPA_005D_SCALE_PA;</a>
<a name="ln128">            break;</a>
<a name="ln129"> </a>
<a name="ln130">        case NPA_700_015D:</a>
<a name="ln131">            *Pmax = NPA_015D_SCALE_PA;</a>
<a name="ln132">            *Pmin = -1.0F * NPA_015D_SCALE_PA;</a>
<a name="ln133">            break;</a>
<a name="ln134"> </a>
<a name="ln135">        case NPA_700_030D:</a>
<a name="ln136">            *Pmax = NPA_030D_SCALE_PA;</a>
<a name="ln137">            *Pmin = -1.0F * NPA_030D_SCALE_PA;</a>
<a name="ln138">            break;</a>
<a name="ln139"> </a>
<a name="ln140">        default:</a>
<a name="ln141">            ret_code |= NPA_ERR_FATAL;</a>
<a name="ln142">            break;</a>
<a name="ln143">    }</a>
<a name="ln144"> </a>
<a name="ln145">    return ret_code;</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148">static npa_ret_t parse_value (const npa_variant_t model, const uint8_t * const raw_data,</a>
<a name="ln149">                              float * const pressure_pa)</a>
<a name="ln150">{</a>
<a name="ln151">    npa_ret_t ret_code = NPA_SUCCESS;</a>
<a name="ln152">    // Mask status bits out</a>
<a name="ln153">    const uint16_t OUT_U16 = ( (raw_data[0U] &lt;&lt; 8U) + raw_data[1U]) &amp; 0x3FFFU;</a>
<a name="ln154">    // Use floats in calculation</a>
<a name="ln155">    float Pmin = 0.0F;</a>
<a name="ln156">    float Pmax = 0.0F;</a>
<a name="ln157">    const float OUTmax = NPA_PRES_MAX_NONSAT;</a>
<a name="ln158">    const float OUTmin = NPA_PRES_MIN_NONSAT;</a>
<a name="ln159">    const float OUT = OUT_U16;</a>
<a name="ln160"> </a>
<a name="ln161">    if (check_saturation (OUT_U16))</a>
<a name="ln162">    {</a>
<a name="ln163">        ret_code |= NPA_WARN_SAT;</a>
<a name="ln164">    }</a>
<a name="ln165"> </a>
<a name="ln166">    ret_code |= get_scaling (model, &amp;Pmax, &amp;Pmin);</a>
<a name="ln167">    /*</a>
<a name="ln168">     * Pressure can be calculated from the sensor output using the following formula:</a>
<a name="ln169">     *</a>
<a name="ln170">     * P = Pmin + (OUT - OUTmin) / (OUTmax - OUTmin) * (Pmax - Pmin)</a>
<a name="ln171">     */</a>
<a name="ln172">    *pressure_pa = Pmin + (OUT - OUTmin) / (OUTmax - OUTmin) * (Pmax - Pmin);</a>
<a name="ln173">    return ret_code;</a>
<a name="ln174">}</a>
<a name="ln175"> </a>
<a name="ln176">npa_ret_t npa_sample_trigger (const npa_ctx_t * const sensor)</a>
<a name="ln177">{</a>
<a name="ln178">    npa_ret_t ret_code = npa_ctx_check (sensor);</a>
<a name="ln179"> </a>
<a name="ln180">    if (NPA_SUCCESS == ret_code)</a>
<a name="ln181">    {</a>
<a name="ln182">        /*</a>
<a name="ln183">        This command wakes up the sensor and starts an internal measurement cycle.</a>
<a name="ln184">        When the measurements are made and the associated calculations are completed,</a>
<a name="ln185">        the corrected values of pressure and temperature are written to the output</a>
<a name="ln186">        register. The sensor then returns to ‘sleep mode’. The values in the output</a>
<a name="ln187">        register can then be read using the Data Fetch commands shown in section 4.4.</a>
<a name="ln188"> </a>
<a name="ln189">        The same wake up function as the Read_MR command can also be accomplished by using</a>
<a name="ln190">        the Read_DF2 or Read_DF3 commands described in section 4.4 and ignoring the</a>
<a name="ln191">        “stale” data that will be returned.</a>
<a name="ln192"> </a>
<a name="ln193">        - Application guide p.15</a>
<a name="ln194">        */</a>
<a name="ln195">        ret_code |= sensor-&gt;read (sensor-&gt;npa_addr, NULL, 0U);</a>
<a name="ln196">    }</a>
<a name="ln197"> </a>
<a name="ln198">    return ret_code;</a>
<a name="ln199">}</a>
<a name="ln200"> </a>
<a name="ln201">npa_ret_t npa_read_pressure (const npa_ctx_t * const sensor,</a>
<a name="ln202">                             float * const pressure_pa)</a>
<a name="ln203">{</a>
<a name="ln204">    npa_ret_t ret_code = npa_ctx_check (sensor);</a>
<a name="ln205"> </a>
<a name="ln206">    if (NULL == pressure_pa)</a>
<a name="ln207">    {</a>
<a name="ln208">        ret_code |= NPA_ERR_NULL;</a>
<a name="ln209">    }</a>
<a name="ln210"> </a>
<a name="ln211">    if (NPA_SUCCESS == ret_code)</a>
<a name="ln212">    {</a>
<a name="ln213">        // Initialize raw data as all bits set, as it sets internal error code on</a>
<a name="ln214">        // by default.</a>
<a name="ln215">        uint8_t raw_data[2U] = { 0xFFU, 0xFFU };</a>
<a name="ln216">        ret_code |= sensor-&gt;read (sensor-&gt;npa_addr, raw_data, sizeof (raw_data));</a>
<a name="ln217">        ret_code |= parse_status (raw_data[0U]);</a>
<a name="ln218">        ret_code |= parse_value (sensor-&gt;model, raw_data, pressure_pa);</a>
<a name="ln219">    }</a>
<a name="ln220"> </a>
<a name="ln221">    return ret_code;</a>
<a name="ln222">}</a>
<a name="ln223"> </a>
<a name="ln224">npa_ret_t npa_read_pressure_temp_lowres (const npa_ctx_t * const sensor,</a>
<a name="ln225">        float * const pressure_pa,</a>
<a name="ln226">        float * const temperature_c)</a>
<a name="ln227">{</a>
<a name="ln228">    return NPA_ERR_IMPL;</a>
<a name="ln229">}</a>
<a name="ln230"> </a>
<a name="ln231">npa_ret_t npa_read_pressure_temp_hires (const npa_ctx_t * const sensor,</a>
<a name="ln232">                                        float * const pressure_pa,</a>
<a name="ln233">                                        float * const temperature_c)</a>
<a name="ln234">{</a>
<a name="ln235">    return NPA_ERR_IMPL;</a>
<a name="ln236">}</a>
<a name="ln237"> </a>
<a name="ln238">/** @} */</a>

</code></pre>
<div class="balloon" rel="53"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'data >> 6U' expression should not be converted from the essential 'signed' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="86"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="153"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="153"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '&' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="153"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '((raw_data[0U] << 8U) + raw_data[1U])' of the '&' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="153"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="157"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(14745U)' expression should not be converted from the essential 'unsigned' type to the essential 'floating' type.</p></div>
<div class="balloon" rel="158"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(1638U)' expression should not be converted from the essential 'unsigned' type to the essential 'floating' type.</p></div>
<div class="balloon" rel="159"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'OUT_U16' expression should not be converted from the essential 'unsigned' type to the essential 'floating' type.</p></div>
<div class="balloon" rel="224"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'pressure_pa'.</p></div>
<div class="balloon" rel="224"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'sensor'.</p></div>
<div class="balloon" rel="224"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'temperature_c'.</p></div>
<div class="balloon" rel="231"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'pressure_pa'.</p></div>
<div class="balloon" rel="231"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'sensor'.</p></div>
<div class="balloon" rel="231"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'temperature_c'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
